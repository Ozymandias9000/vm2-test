var express = require("express")
var DomParser = require("dom-parser")
var parser = new DomParser()

var router = express.Router()
const { NodeVM, VMScript } = require("vm2")
const handleError = require("../utils/handleError")

/* POST home page. */
router.post("/", function (req, res, next) {
  const vm = new NodeVM({
    sandbox: { console },
  })

  let script
  try {
    const { code } = req.body

    script = new VMScript(code).compile()
  } catch (e) {
    return next(e)
  }

  let functionInSandbox = vm.run(script)

  const mockDoc = parser.parseFromString(
    `<div id="root"><div class="App"><div class="react-monaco-editor-container" data-keybinding-context="1" data-mode-id="plaintext" style="width: 800px; height: 600px;"><div class="monaco-editor no-user-select mac  showUnused vs-dark" data-uri="inmemory://model/1" style="width: 800px; height: 600px;"><div data-mprt="3" class="overflow-guard" style="width: 800px; height: 600px;"><div class="margin" role="presentation" aria-hidden="true" style="position: absolute; transform: translate3d(0px, 0px, 0px); contain: strict; top: 0px; height: 708px; width: 62px;"><div class="glyph-margin" style="left: 0px; width: 0px; height: 708px;"></div><div class="margin-view-zones" role="presentation" aria-hidden="true" style="position: absolute;"></div><div class="margin-view-overlays" role="presentation" aria-hidden="true" style="position: absolute; width: 62px; font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-weight: normal; font-size: 12px; font-feature-settings: &quot;liga&quot; 0, &quot;calt&quot; 0; line-height: 18px; letter-spacing: 0px; height: 708px;"><div style="position:absolute;top:0px;width:100%;height:18px;"><div class="line-numbers" style="left:0px;width:36px;">1</div></div><div style="position:absolute;top:18px;width:100%;height:18px;"><div class="line-numbers" style="left:0px;width:36px;">2</div></div><div style="position:absolute;top:36px;width:100%;height:18px;"><div class="line-numbers" style="left:0px;width:36px;">3</div></div><div style="position:absolute;top:54px;width:100%;height:18px;"><div class="line-numbers" style="left:0px;width:36px;">4</div></div><div style="position:absolute;top:72px;width:100%;height:18px;"><div class="line-numbers" style="left:0px;width:36px;">5</div></div><div style="position:absolute;top:90px;width:100%;height:18px;"><div class="line-numbers" style="left:0px;width:36px;">6</div></div><div style="position:absolute;top:108px;width:100%;height:18px;"><div class="line-numbers" style="left:0px;width:36px;">7</div></div></div></div><div class="monaco-scrollable-element editor-scrollable vs-dark mac" role="presentation" data-mprt="5" style="position: absolute; overflow: hidden; left: 62px; width: 738px; height: 600px;"><div class="lines-content monaco-editor-background" style="position: absolute; overflow: hidden; width: 1e+06px; height: 1e+06px; transform: translate3d(0px, 0px, 0px); contain: strict; top: 0px; left: 0px;"><div class="view-overlays" role="presentation" aria-hidden="true" style="position: absolute; height: 0px; width: 650px;"><div style="position:absolute;top:0px;width:100%;height:18px;"></div><div style="position:absolute;top:18px;width:100%;height:18px;"></div><div style="position:absolute;top:36px;width:100%;height:18px;"><div class="cigr" style="left:0px;height:18px;width:28.890625px"></div></div><div style="position:absolute;top:54px;width:100%;height:18px;"><div class="cigr" style="left:0px;height:18px;width:28.890625px"></div></div><div style="position:absolute;top:72px;width:100%;height:18px;"><div class="cigr" style="left:0px;height:18px;width:28.890625px"></div></div><div style="position:absolute;top:90px;width:100%;height:18px;"><div class="cigr" style="left:0px;height:18px;width:28.890625px"></div></div><div style="position:absolute;top:108px;width:100%;height:18px;"></div></div><div role="presentation" aria-hidden="true" class="view-rulers"></div><div class="view-zones" role="presentation" aria-hidden="true" style="position: absolute;"></div><div class="view-lines" role="presentation" aria-hidden="true" data-mprt="7" style="position: absolute; font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-weight: normal; font-size: 12px; font-feature-settings: &quot;liga&quot; 0, &quot;calt&quot; 0; line-height: 18px; letter-spacing: 0px; width: 650px; height: 708px;"><div style="top:0px;height:18px;" class="view-line"><span><span class="mtk1">module.exports&nbsp;=&nbsp;(page)&nbsp;=&gt;&nbsp;{</span></span></div><div style="top:18px;height:18px;" class="view-line"><span><span class="mtk1">/**&nbsp;DO&nbsp;NOT&nbsp;CHANGE&nbsp;ABOVE&nbsp;THIS&nbsp;LINE&nbsp;*/</span></span></div><div style="top:36px;height:18px;" class="view-line"><span><span>&nbsp;</span></span></div><div style="top:54px;height:18px;" class="view-line"><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Add&nbsp;your&nbsp;selector&nbsp;below</span></span></div><div style="top:72px;height:18px;" class="view-line"><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;console.log(page)</span></span></div><div style="top:90px;height:18px;" class="view-line"><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;page.querySelector('.myClass')&nbsp;//&nbsp;Example</span></span></div><div style="top:108px;height:18px;" class="view-line"><span><span class="mtk1">}</span></span></div></div><div data-mprt="1" class="contentWidgets" style="position: absolute; top: 0px;"></div><div role="presentation" aria-hidden="true" class="cursors-layer cursor-line-style cursor-solid"><div class="cursor " style="height: 18px; top: 0px; left: 0px; font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-weight: normal; font-size: 12px; font-feature-settings: &quot;liga&quot; 0, &quot;calt&quot; 0; line-height: 18px; letter-spacing: 0px; display: block; visibility: hidden; width: 1.81818px;"></div></div></div><div role="presentation" aria-hidden="true" class="invisible scrollbar horizontal" style="position: absolute; width: 636px; height: 10px; left: 0px; bottom: 0px;"><div class="slider" style="position: absolute; top: 0px; left: 0px; height: 10px; transform: translate3d(0px, 0px, 0px); contain: strict; width: 636px;"></div></div><canvas class="decorationsOverviewRuler" aria-hidden="true" width="15" height="660" style="position: absolute; transform: translate3d(0px, 0px, 0px); contain: strict; top: 0px; right: 0px; width: 14px; height: 600px;"></canvas><div role="presentation" aria-hidden="true" class="invisible scrollbar vertical fade" style="position: absolute; width: 14px; height: 600px; right: 0px; top: 0px;"><div class="slider" style="position: absolute; top: 0px; left: 0px; width: 14px; transform: translate3d(0px, 0px, 0px); contain: strict; height: 508px;"></div></div></div><div role="presentation" aria-hidden="true" style="width: 698px;"></div><textarea data-mprt="6" class="inputarea" wrap="off" autocorrect="off" autocapitalize="off" autocomplete="off" spellcheck="false" aria-label="Editor content;Press Alt+F1 for Accessibility Options." role="textbox" aria-multiline="true" aria-haspopup="false" aria-autocomplete="both" style="font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-weight: normal; font-size: 12px; font-feature-settings: &quot;liga&quot; 0, &quot;calt&quot; 0; line-height: 18px; letter-spacing: 0px; top: 0px; left: 62px; width: 1px; height: 18px;"></textarea><div style="position: absolute; top: 0px; left: 0px; width: 0px; height: 0px;"></div><div data-mprt="4" class="overlayWidgets" style="width: 800px;"></div><div data-mprt="8" class="minimap slider-mouseover" role="presentation" aria-hidden="true" style="position: absolute; left: 698px; width: 88px; height: 600px;"><div class="minimap-shadow-hidden" style="height: 600px;"></div><canvas width="96" height="660" style="position: absolute; left: 0px; width: 87.2727px; height: 600px;"></canvas><canvas class="minimap-decorations-layer" width="96" height="660" style="position: absolute; left: 0px; width: 87.2727px; height: 600px;"></canvas><div class="minimap-slider" style="position: absolute; transform: translate3d(0px, 0px, 0px); contain: strict; width: 88px; top: 0px; height: 60px;"><div class="minimap-slider-horizontal" style="position: absolute; left: 0px; width: 88px; top: 0px; height: 60px;"></div></div></div></div><div data-mprt="2" class="overflowingContentWidgets"></div><div class="context-view" aria-hidden="true" style="display: none;"></div></div></div><button id='submit' type="submit">Submit</button></div></div>`
  )

  functionInSandbox(mockDoc)

  res.send("OK")
})

router.use(handleError)

module.exports = router
